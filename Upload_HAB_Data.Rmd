---
title: "HABMAP Data"
author: "Megan Hepner"
date: "6/17/2019"
output: html_document
---

```{r Libraries, echo=T, warning=F, error=F, message=F, tidy=T}

#rm(list=ls()) 
library(rerddap)
library(tidyverse)

```

Example [R code](https://rmendels.github.io/Using_rerddap.nb.html) on how to download data from ERDDAP Servers by Roy Mendelssohn and Scott Chamberlain. 

```{r Example, echo=T}

#IOOS Glider Data
Glider = info("sp064-20161214T1913", url="https://data.ioos.us/gliders/erddap/")
glider_data = tabledap(Glider, fields = c('depth', 'salinity','time'),'time>=2016-12-14', 'time<=2016-12-23', url='https://data.ioos.us/gliders/erddap/')

#Example CalCOFI 
CalCOFI = info('siocalcofiHydroCasts')
#CalCOFI2 = info("siocalcofiHydroCasts", url="https://coastwatch.pfeg.noaa.gov/erddap/") works with both methods 
calcofi.df <- tabledap(CalCOFI, 
                       fields = c('cst_cnt',  'date', 'year', 'month', 'julian_date', 'julian_day', 'rpt_line', 'rpt_sta', 'cruz_num', 'intchl', 'intc14', 'time'),
                       'time>=1984-01-01T00:00:00Z', 'time<=2014-04-17T05:35:00Z')

```

### ERDDAP Dataset ID:
1. [HABs-CalPoly](http://erddap.sccoos.org/erddap/tabledap/HABs-CalPoly.html)
2. [HABs-MontereyWharf](http://erddap.sccoos.org/erddap/tabledap/HABs-MontereyWharf.html)
3. [HABs-NewportPier](http://erddap.sccoos.org/erddap/tabledap/HABs-NewportPier.html) 
4. [HABs-SantaCruzWharf](http://erddap.sccoos.org/erddap/tabledap/HABs-SantaCruzWharf.html) 
5. [HABs-SantaMonicaPier](http://erddap.sccoos.org/erddap/tabledap/HABs-SantaMonicaPier.html)
6. [HABs-ScrippsPier](http://erddap.sccoos.org/erddap/tabledap/HABs-ScrippsPier.html) 
7. [HABs-StearnsWharf](http://erddap.sccoos.org/erddap/tabledap/HABs-StearnsWharf.html)

### HABMAP Variables: 
1. Akashiwo_sanguinea                        
2. Alexandrium_spp                             
3. Ammonium     
4. Avg_Chloro     
5. Avg_Phaeo     
6. Ceratium                      
7. Chl_Volume_Filtered     
8. Chl1   
9. Chl2   
10. Cochlodinium                          
11. DA_Volume_Filtered    
12. dDA                          
13. depth    
14. Dinophysis_spp    
15. Gymnodinium_spp       
16. latitude     
17. Lingulodinium_polyedra                     
18. Location_Code                           
19. longitude    
20. Nitrate   
21. Nitrite     
22. Nitrite_Nitrate   
23. Other_Diatoms                         
24. Other_Dinoflagellates                           
25. pDA                            
26. Phaeo1     
27. Phaeo2    
28. Phosphate    
29. Prorocentrum_spp                              
30. Pseudo_nitzschia_delicatissima_group                              
31. Pseudo_nitzschia_seriata_group                              
32. SampleID                               
33. Silicate     
34. tDA                           
35. Temp                          
36. time    
37. Total_Phytoplankton                           
38. Volume_Settled_for_Counting     

### Pull HABMAP Data from [ERDDAP](http://erddap.sccoos.org/erddap/) 

```{r Download HABMAP Data from ERDDAP, echo=T, tidy=T}

#variables = c('Location_Code','time','Akashiwo_sanguinea', 'Alexandrium_spp','Ceratium', 'Cochlodinium', 'Dinophysis_spp', 'Gymnodinium_spp', 'Lingulodinium_polyedra', 'Prorocentrum_spp','Pseudo_nitzschia_delicatissima_group','Pseudo_nitzschia_seriata_group','pDA', 'Ammonium','Avg_Chloro','Avg_Phaeo','Nitrate','Phosphate', 'Silicate', 'Temp')

variables = c('Location_Code','time','Alexandrium_spp', 'Dinophysis_spp', 'Gymnodinium_spp', 'Lingulodinium_polyedra', 'Prorocentrum_spp','Pseudo_nitzschia_delicatissima_group','Pseudo_nitzschia_seriata_group','pDA', 'Ammonium','Avg_Chloro','Avg_Phaeo','Nitrate','Phosphate', 'Silicate', 'Temp')

CalPoly = rerddap::info(datasetid = "HABs-CalPoly", url="http://erddap.sccoos.org/erddap/")
CalPoly_Data = tabledap(CalPoly, fields = variables, 'time>=2008-01-01T00:00:00Z', 'time<=2050-04-17T05:35:00Z', url = "http://erddap.sccoos.org/erddap/")
#Does not have data for Akashiwo_sanguinea, Ceratium, Cochlodinium, tDA

Monterey = info("HABs-MontereyWharf",url= "http://erddap.sccoos.org/erddap/") 
Monterey_Data = tabledap(Monterey, fields = variables, 'time>=2008-08-01T00:00:00Z', 'time<=2050-04-17T05:35:00Z', url = "http://erddap.sccoos.org/erddap/")

Newport = info("HABs-NewportPier",url= "http://erddap.sccoos.org/erddap/") 
Newport_Data = tabledap(Newport, fields = variables, 'time>=2008-01-01T00:00:00Z', 'time<=2050-04-17T05:35:00Z', url = "http://erddap.sccoos.org/erddap/")

SantaCruz = info("HABs-SantaCruzWharf",url= "http://erddap.sccoos.org/erddap/") 
SantaCruz_Data = tabledap(SantaCruz, fields = variables, 'time>=2008-01-01T00:00:00Z', 'time<=2050-04-17T05:35:00Z', url = "http://erddap.sccoos.org/erddap/")

SantaMonica = info("HABs-SantaMonicaPier",url= "http://erddap.sccoos.org/erddap/") 
SantaMonica_Data = tabledap(SantaMonica, fields = variables, 'time>=2008-01-01T00:00:00Z', 'time<=2050-04-17T05:35:00Z', url = "http://erddap.sccoos.org/erddap/")

Scripps = info("HABs-ScrippsPier",url= "http://erddap.sccoos.org/erddap/") 
Scripps_Data = tabledap(Scripps, fields = variables, 'time>=2008-01-01T00:00:00Z', 'time<=2050-04-17T05:35:00Z', url = "http://erddap.sccoos.org/erddap/")

Stearns = info("HABs-StearnsWharf",url= "http://erddap.sccoos.org/erddap/") 
Stearns_Data = tabledap(Stearns, fields = variables, 'time>=2008-01-01T00:00:00Z', 'time<=2050-04-17T05:35:00Z', url = "http://erddap.sccoos.org/erddap/")

#Bind all the Data into one datatable 

HABMAP_Data = dplyr::bind_rows(list(CalPoly_Data, Monterey_Data,Newport_Data,SantaCruz_Data,SantaMonica_Data,Scripps_Data,Stearns_Data))

```

### Arrange Data in Long Format and Save 
```{r HABMAP Data in Long Format}

HABMAP_Data_Long = HABMAP_Data %>%   
  gather(key = "Observations", value = "Measurement", 'Akashiwo_sanguinea', 'Alexandrium_spp','Ceratium', 'Cochlodinium', 'Dinophysis_spp', 'Gymnodinium_spp', 'Lingulodinium_polyedra', 'Prorocentrum_spp','Pseudo_nitzschia_delicatissima_group','Pseudo_nitzschia_seriata_group','pDA', 'Ammonium','Avg_Chloro','Avg_Phaeo','Nitrate','Phosphate', 'Silicate', 'Temp')
         
#Add a column for units - need this for Shiny app 
HABMAP_Data_Long_Units = HABMAP_Data_Long %>% 
  mutate(Units = ifelse(grepl("pDA", Observations),'ng/mL',
                        ifelse(grepl('Temp', Observations), "Celsius",
                               ifelse(grepl("'Avg_Chloro'|'Avg_Phaeo'", Observations), "mg/m3",
                                      ifelse(grepl("
                                      'Akashiwo_sanguinea'|
                                      'Alexandrium_spp'|
                                      'Ceratium'|
                                      'Cochlodinium'|
                                      'Dinophysis_spp'|
                                      'Gymnodinium_spp'|
                                      'Lingulodinium_polyedra'|
                                      'Prorocentrum_spp'|
                                      'Pseudo_nitzschia_delicatissima_group'|
                                      'Pseudo_nitzschia_seriata_group'", Observations), "cells/L", "uM")))))

HABMAP_Data_Long_Units = HABMAP_Data_Long_Units %>%
  mutate(Date = as.Date(time)) %>%
  select(Location_Code, Date, Observations, Measurement, Units)%>%
  as.tibble()
  

#Save HABMAP long formated data table 
write_rds(HABMAP_Data_Long_Units, "HABMAP_Data/HABMAP_Data_Long_Units.rds")


```

```{r Roy}

CalPoly_Data = tabledap(CalPoly, fields = 'Pseudo_nitzschia_seriata_group', 'time>=2008-01-01T00:00:00Z', 'time<=2050-04-17T05:35:00Z', url = "http://erddap.sccoos.org/erddap/")
str(CalPoly_Data)

#Classes ‘tabledap’ and 'data.frame':  557 obs. of  1 variable:
#$ Pseudo_nitzschia_seriata_group: chr  "3198.8298" "41584.785" "8530.213" "0.0" ...
#- attr(*, "datasetid")= chr "HABs-CalPoly"
#- attr(*, "path")= chr "/Users/rmendels/Library/Caches/R/rerddap/ecb5ae0e53ec761b7ac2c2aade7670b4.csv"
#- attr(*, "url")= chr "http://erddap.sccoos.org/erddap/tabledap/HABs-CalPoly.csv?Pseudo_nitzschia_seriata_group&time%3E%3D2008-01-01T0"| __truncated__

variables = c('Location_Code','time','Akashiwo_sanguinea','Alexandrium_spp', 'Dinophysis_spp',  'Lingulodinium_polyedra', 'Prorocentrum_spp','Pseudo_nitzschia_delicatissima_group','Pseudo_nitzschia_seriata_group','pDA', 'Ammonium','Avg_Chloro','Avg_Phaeo','Nitrate','Phosphate', 'Silicate', 'Temp')

HABMAP = rerddap::info(datasetid = "HABs-pre20190601", url="http://erddap.sccoos.org/erddap/")
HABMAP_Data = tabledap(CalPoly, fields = variables, 'time>=2008-01-01T00:00:00Z', 'time<=2050-04-17T05:35:00Z', url = "http://erddap.sccoos.org/erddap/")
#Does not have data for Akashiwo_sanguinea, Ceratium, Cochlodinium, 'Gymnodinium_spp', Other_Diatoms, Other_Dinoflagellates, Total_Phytoplankton, #dDA, tDA #Nitrite_Nitrate, sample ID

HABMAP_Data = read_csv("HABMAP_Data/HABMAP_data_test.csv")

HABMAP_Data_Long = HABMAP_Data %>%   
  gather(key = "Observations", value = "Measurement", 'Akashiwo_sanguinea', 'Alexandrium_spp','Dinophysis_spp', 'Lingulodinium_polyedra', 'Prorocentrum_spp','Pseudo_nitzschia_delicatissima_group','Pseudo_nitzschia_seriata_group','Ammonium','Avg_Chloro','Avg_Phaeo','Nitrate','Phosphate', 'Silicate', 'Temp')

#Add a column for units - need this for Shiny app 
HABMAP_Data_Long_Units = HABMAP_Data_Long %>% 
  mutate(Units = ifelse(grepl('Temp', Observations), "Celsius",
                               ifelse(grepl("'Avg_Chloro'|'Avg_Phaeo'", Observations), "mg/m3",
                                      ifelse(grepl("
                                      'Akashiwo_sanguinea'|
                                      'Alexandrium_spp'|
                                      'Dinophysis_spp'|
                                      'Lingulodinium_polyedra'|
                                      'Prorocentrum_spp'|
                                      'Pseudo_nitzschia_delicatissima_group'|
                                      'Pseudo_nitzschia_seriata_group'", Observations), "cells/L", "uM"))))

HABMAP_Data_Long_Units_Date = HABMAP_Data_Long_Units %>%
  mutate(Date = as.Date(time))%>%
  select(Location_Code, Date, Observations, Measurement, Units)
  
HABMAP_Data_Long_Units_Date = as.tibble(HABMAP_Data_Long_Units_Date)
write_csv(HABMAP_Data_Long_Units_Date, "HABMAP_data_test2.csv")

#Save HABMAP long formated data table 
write_rds(HABMAP_Data_Long_Units, "HABMAP_Data/HABMAP_Data_Long_Units_test.rds")


```
