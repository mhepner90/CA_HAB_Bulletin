---
title: "HAB Data"
author: "Megan Hepner"
date: "6/17/2019"
output: html_document
---

```{r setup, include=FALSE}

#getwd() "/home/rstudio/mhepner/SCCOOS Products"
#rm(list=ls()) 
library(rerddap)
library(tidyverse)
library(ggplot2) #ggplot

```

ERDDAP Dataset ID:
[HABs-CalPoly](http://erddap.sccoos.org/erddap/tabledap/HABs-CalPoly.html)
[HABs-MontereyWharf](http://erddap.sccoos.org/erddap/tabledap/HABs-MontereyWharf.html)
[HABs-NewportPier](http://erddap.sccoos.org/erddap/tabledap/HABs-NewportPier.html) 
[HABs-SantaCruzWharf](http://erddap.sccoos.org/erddap/tabledap/HABs-SantaCruzWharf.html) 
[HABs-SantaMonicaPier](http://erddap.sccoos.org/erddap/tabledap/HABs-SantaMonicaPier.html)
[HABs-ScrippsPier](http://erddap.sccoos.org/erddap/tabledap/HABs-ScrippsPier.html) 
[HABs-StearnsWharf](http://erddap.sccoos.org/erddap/tabledap/HABs-StearnsWharf.html)

```{r download data from ERDDAP}

CalCOFI = info('siocalcofiHydroCasts')
calcofi.df <- tabledap(CalCOFI, 
                       fields = c('cst_cnt',  'date', 'year', 'month', 'julian_date', 'julian_day', 'rpt_line', 'rpt_sta', 'cruz_num', 'intchl', 'intc14', 'time'),
                       'time>=1984-01-01T00:00:00Z', 'time<=2014-04-17T05:35:00Z')

CalPoly = info("HABs-CalPoly", url= "http://erddap.sccoos.org/erddap/tabledap/")
#CalPoly = info("HABs-CalPoly", url= "http://erddap.sccoos.org/erddap/")
CalPoly_Data = tabledap(CalPoly, 
                        fields = c('Ceratium','Cochlodinium', 'Dinophysis_spp', 'Gymnodinium_spp','time'),
                        'time >= 2008-08-15T00:00:00Z', 'time <= 2019-05-26T05:35:00Z')

                        #''Akashiwo_sanguinea', 'Alexandrium_spp',' Ceratium', 'Cochlodinium', 'Dinophysis_spp', 'Gymnodinium_spp', 'Lingulodinium_polyedra', 'Prorocentrum_spp','Pseudo_nitzschia_delicatissima_group','Pseudo_nitzschia_seriata_group','pDA'), 'time>=2009-01-01T00:00:00Z', 'time<=2014-04-17T05:35:00Z')

#'Ammonium','Avg_Chloro','Avg_Phaeo','Nitrate','Phosphate', 'Silicate', 'Temp'
#'Other_Diatoms','Other_Dinoflagellates', 'Total_Phytoplankton', 'tDA'

Monterey = info("HABs-MontereyWharf",url= "http://erddap.sccoos.org/erddap/") 

Newport = info("HABs-NewportPier",url= "http://erddap.sccoos.org/erddap/") 

SantaCruz = info("HABs-SantaCruzWharf",url= "http://erddap.sccoos.org/erddap/") 

SantaMonica = info("HABs-SantaMonicaPier",url= "http://erddap.sccoos.org/erddap/") 

Scripps = info("HABs-ScrippsPier",url= "http://erddap.sccoos.org/erddap/") 

Stearns = info("HABs-StearnsWharf",url= "http://erddap.sccoos.org/erddap/") 


```

cols(
  `Latitude (dec deg N)` = col_double(),
  `Longitude (dec deg E)` = col_double(),
  `Depth (m)` = col_double(),
  `SampleID` = col_character(),
  `Location Code` = col_character(),
  `Date Collected (YYYY-MM-DD)` = col_date(format = ""),
  `Time Collected (hh:mm:ss PT)` = col_time(format = ""),
  `Temp (deg C)` = col_double(),
  `Chl Volume Filtered (mL)` = col_double(),
  `Chl1 (mg/m3)` = col_double(),
  `Chl2 (mg/m3)` = col_double(),
  `Avg Chloro (mg/m3)` = col_double(),
  `Phaeo1 (mg/m3)` = col_double(),
  `Phaeo2 (mg/m3)` = col_double(),
  `Avg Phaeo (mg/m3)` = col_double(),
  `Nitrate (uM)` = col_double(),
  `Phosphate (uM)` = col_double(),
  `Silicate (uM)` = col_double(),
  `Nitrite (uM)` = col_double(),
  `Ammonium (uM)` = col_double(),
  `DA Volume Filtered (mL)` = col_double(),
  `pDA (ng/mL)` = col_double(),
  `tDA` = col_logical(),
  `dDA` = col_logical(),
  `Volume Settled for counting (mL)` = col_double(),
  `Akashiwo sanguinea  (cells/L)` = col_double(),
  `Alexandrium spp. (cells/L)` = col_double(),
  `Dinophysis spp.  (cells/L)` = col_double(),
  `Lingulodinium polyedrum (cells/L)` = col_double(),
  `Prorocentrum spp.  (cells/L)` = col_double(),
  `Pseudo-nitzschia delicatissima group (cells/L)` = col_double(),
  `Pseudo-nitzschia seriata group (cells/L)` = col_double(),
  `Other Diatoms (cells/L)` = col_double(),
  `Other Dinoflagellates (cells/L)` = col_double(),
  `Ceratium spp.(cells/L)` = col_double(),
  `Cochlodinium (cells/L)` = col_double(),
  `Gymnodinium spp. (cells/L)` = col_double(),
  `Total Phytoplankton (cells/L)` = col_double()
  
```{r Format Nutrient Data}

Cal_Poly_Org = read_csv("/Volumes/GoogleDrive/My Drive/SCCOOS/CA_HAB_Bulletin/2019_05/HABMAP_data/CPP_upload.csv") #550x39
Cal_Poly_Org = Cal_Poly_Org %>%
  select("Location Code", `Date Collected (YYYY-MM-DD)`,`Temp (deg C)`,`Nitrate (uM)`, `Phosphate (uM)`,`Silicate (uM)`,`Ammonium (uM)`,`Avg Chloro (mg/m3)`)%>% 
  mutate(`Date Collected (YYYY-MM-DD)` = as.character(`Date Collected (YYYY-MM-DD)`))
Newport_Org = read_csv("/Volumes/GoogleDrive/My Drive/SCCOOS/CA_HAB_Bulletin/2019_05/HABMAP_data/NP_upload.csv")  #560x33 missing lat,long,depth,SampleID,year, week
Newport_Org = Newport_Org %>%
  select("Location Code", `Date Collected (YYYY-MM-DD)`,`Temp (deg C)`,`Nitrate (uM)`, `Phosphate (uM)`,`Silicate (uM)`,`Ammonium (uM)`,`Avg Chloro (mg/m3)`)%>% 
  mutate(`Date Collected (YYYY-MM-DD)` = as.character(`Date Collected (YYYY-MM-DD)`))

Santa_Cruz_Org = read_csv("/Volumes/GoogleDrive/My Drive/SCCOOS/CA_HAB_Bulletin/2019_05/HABMAP_data/SCW_upload.csv") #382x27 missing
Santa_Cruz_Org = Santa_Cruz_Org %>%  
  select("Location Code", `Date Collected (YYYY-MM-DD)`,`Temp (deg C)`,`Nitrate (uM)`, `Phosphate (uM)`,`Silicate (uM)`,`Ammonium (uM)`,`Avg Chloro (mg/m3)`) %>% 
  mutate(`Date Collected (YYYY-MM-DD)` = as.character(`Date Collected (YYYY-MM-DD)`))

Stearn_Wharf_Org = read_csv("/Volumes/GoogleDrive/My Drive/SCCOOS/CA_HAB_Bulletin/2019_05/HABMAP_data/SW_upload.csv") #552x39
Stearn_Wharf_Org = Stearn_Wharf_Org %>%
  select("Location Code", `Date Collected (YYYY-MM-DD)`,`Temp (deg C)`,`Nitrate (uM)`, `Phosphate (uM)`,`Silicate (uM)`,`Ammonium (uM)`,`Avg Chloro (mg/m3)`)%>%
  mutate(`Date Collected (YYYY-MM-DD)` = as.character(`Date Collected (YYYY-MM-DD)`))
#Scripps_Pier_Org = read_csv("/Volumes/GoogleDrive/My Drive/SCCOOS/CA_HAB_Bulletin/2019_04/HABMAP_data/SP_upload.csv")
#Santa_Monica_Org = read_csv("/Volumes/GoogleDrive/My Drive/SCCOOS/CA_HAB_Bulletin/2019_05/HABMAP_data/SMP_upload.csv")
#Monterey_Org = read_csv("/Volumes/GoogleDrive/My Drive/SCCOOS/CA_HAB_Bulletin/2019_04/HABMAP_data/MW_upload.csv") 

Nutrient_data = dplyr::bind_rows(Cal_Poly_Org, Newport_Org) 
Nutrient_data = dplyr::bind_rows(Nutrient_data, Santa_Cruz_Org) 
Nutrient_data = dplyr::bind_rows(Nutrient_data, Stearn_Wharf_Org)

Nutrient_data = Nutrient_data %>%
  mutate(
    Location =`Location Code`, 
    Date = `Date Collected (YYYY-MM-DD)`,
    Temp = `Temp (deg C)`, 
    Chloro = `Avg Chloro (mg/m3)`,
    Phaeo = `Avg Phaeo (mg/m3)`,
    Nitrate = `Nitrate (uM)`,
    Phosphate = `Phosphate (uM)`,
    Silicate = `Silicate (uM)`,
    Nitrite = `Nitrite (uM)`,
    Amonium = `Ammonium (uM)`) %>%
  select(Location, Date, Temp,Chloro,Phaeo,Nitrite, Nitrate,Phosphate,Silicate, Amonium) 

Nutrient_data_long = Nutrient_data %>%   
  gather(key = "Observations", value = "measurement",Temp,Chloro,Phaeo,Nitrite, Nitrate,Phosphate,Silicate, Amonium)

write_rds(Nutrient_data_long, "HABMAP_Data/Nutrient_data.rds")

Nutrient_data = readRDS("HABMAP_Data/Nutrient_data_long.rds")

```

```{r Format HAB data}

Cal_Poly_Org = read_csv("/Volumes/GoogleDrive/My Drive/SCCOOS/CA_HAB_Bulletin/2019_05/HABMAP_data/CPP_upload.csv") #550x39

Cal_Poly_Org = Cal_Poly_Org %>%
  select("Location Code", 'Date Collected (YYYY-MM-DD)','pDA (ng/mL)','Pseudo-nitzschia delicatissima group (cells/L)','Pseudo-nitzschia seriata group (cells/L)','Alexandrium spp. (cells/L)') %>% 
  mutate(`Date Collected (YYYY-MM-DD)` = as.character(`Date Collected (YYYY-MM-DD)`))

Newport_Org = read_csv("/Volumes/GoogleDrive/My Drive/SCCOOS/CA_HAB_Bulletin/2019_05/HABMAP_data/NP_upload.csv")  #560x33 missing lat,long,depth,SampleID,year, week
Newport_Org = Newport_Org %>%
  select("Location Code", 'Date Collected (YYYY-MM-DD)','pDA (ng/mL)','Pseudo-nitzschia delicatissima group (cells/L)','Pseudo-nitzschia seriata group (cells/L)','Alexandrium spp. (cells/L)') %>% 
  mutate(`Date Collected (YYYY-MM-DD)` = as.character(`Date Collected (YYYY-MM-DD)`))

Santa_Cruz_Org = read_csv("/Volumes/GoogleDrive/My Drive/SCCOOS/CA_HAB_Bulletin/2019_05/HABMAP_data/SCW_upload.csv") #382x27 missing
Santa_Cruz_Org = Santa_Cruz_Org %>%  
  select("Location Code", 'Date Collected (YYYY-MM-DD)','pDA (ng/mL)','Pseudo-nitzschia delicatissima group (cells/L)','Pseudo-nitzschia seriata group (cells/L)','Alexandrium spp. (cells/L)') %>% 
  mutate(`Date Collected (YYYY-MM-DD)` = as.character(`Date Collected (YYYY-MM-DD)`))

Stearn_Wharf_Org = read_csv("/Volumes/GoogleDrive/My Drive/SCCOOS/CA_HAB_Bulletin/2019_05/HABMAP_data/SW_upload.csv") #552x39
Stearn_Wharf_Org = Stearn_Wharf_Org %>%
  select("Location Code", 'Date Collected (YYYY-MM-DD)','pDA (ng/mL)','Pseudo-nitzschia delicatissima group (cells/L)','Pseudo-nitzschia seriata group (cells/L)','Alexandrium spp. (cells/L)')%>%
  mutate(`Date Collected (YYYY-MM-DD)` = as.character(`Date Collected (YYYY-MM-DD)`),
         'pDA (ng/mL)' = as.integer('pDA (ng/mL)'))

HAB_data = dplyr::bind_rows(Cal_Poly_Org, Newport_Org) 
HAB_data = dplyr::bind_rows(HAB_data, Santa_Cruz_Org) 
HAB_data = dplyr::bind_rows(HAB_data, Stearn_Wharf_Org)

HAB_data = HAB_data %>%
  mutate(
    Location =`Location Code`, 
    Date = `Date Collected (YYYY-MM-DD)`,
    pDA = `pDA (ng/mL)`,
    PN_deli = `Pseudo-nitzschia delicatissima group (cells/L)`,
    PN_seri = `Pseudo-nitzschia seriata group (cells/L)`,
    Alex = `Alexandrium spp. (cells/L)`) %>%
  select(Location, Date,pDA,PN_deli,PN_seri,Alex) 

write_csv(HAB_data, "/Volumes/GoogleDrive/My Drive/SCCOOS/CA_HAB_Bulletin/HAB_data.csv")

HAB_data_long = HAB_data %>%   
  gather(key = "Observations", value = "measurement",pDA, PN_deli, PN_seri, Alex)

write_csv(HAB_data_long, "/Volumes/GoogleDrive/My Drive/SCCOOS/CA_HAB_Bulletin/HAB_data_long.csv")

```

```{r HAB data}

Cal_Poly_Org = read_csv("/Volumes/GoogleDrive/My Drive/SCCOOS/CA_HAB_Bulletin/2019_05/HABMAP_data/CPP_upload.csv")
                        #col_types=cols(`Date Collected (YYYY-MM-DD)` = col_date(format="%Y-%m-%d"))) 
#`Date Collected (YYYY-MM-DD)` = col_date(format = ""),

Newport_Org = read_csv("/Volumes/GoogleDrive/My Drive/SCCOOS/CA_HAB_Bulletin/2019_05/HABMAP_data/NP_upload.csv",
                       col_types=cols(`Time Collected (hh:mm:ss PT)` = col_character()))

Santa_Cruz_Org = read_csv("/Volumes/GoogleDrive/My Drive/SCCOOS/CA_HAB_Bulletin/2019_05/HABMAP_data/SCW_upload.csv",
                          col_types=cols(`Time Collected (hh:mm:ss PT)` = col_character()))

Stearn_Wharf_Org = read_csv("/Volumes/GoogleDrive/My Drive/SCCOOS/CA_HAB_Bulletin/2019_05/HABMAP_data/SW_upload.csv",
                            col_types=cols(`Time Collected (hh:mm:ss PT)` = col_character(),
                                          SampleID = col_character(),
                                          `pDA (ng/mL)` = col_double())) 

#Scripps_Pier_Org = read_csv("/Volumes/GoogleDrive/My Drive/SCCOOS/CA_HAB_Bulletin/2019_04/HABMAP_data/SP_upload.csv")
#Santa_Monica_Org = read_csv("/Volumes/GoogleDrive/My Drive/SCCOOS/CA_HAB_Bulletin/2019_05/HABMAP_data/SMP_upload.csv")
#Monterey_Org = read_csv("/Volumes/GoogleDrive/My Drive/SCCOOS/CA_HAB_Bulletin/2019_04/HABMAP_data/MW_upload.csv") 

HAB_data = dplyr::bind_rows(Cal_Poly_Org, Newport_Org) 
HAB_data = dplyr::bind_rows(HAB_data, Santa_Cruz_Org) 
HAB_data = dplyr::bind_rows(HAB_data, Stearn_Wharf_Org)

HAB_data = HAB_data %>%
  select('Location Code', 'Date Collected (YYYY-MM-DD)','pDA (ng/mL)','Pseudo-nitzschia delicatissima group (cells/L)','Pseudo-nitzschia seriata group (cells/L)','Alexandrium spp. (cells/L)','Temp (deg C)','Nitrate (uM)', 'Phosphate (uM)','Silicate (uM)','Ammonium (uM)','Avg Chloro (mg/m3)','Avg Phaeo (mg/m3)')

HAB_data_long = HAB_data %>%   
  gather(key = "Observations", value = "Measurement", 'pDA (ng/mL)','Pseudo-nitzschia delicatissima group (cells/L)','Pseudo-nitzschia seriata group (cells/L)','Alexandrium spp. (cells/L)','Temp (deg C)','Nitrate (uM)', 'Phosphate (uM)','Silicate (uM)','Ammonium (uM)','Avg Chloro (mg/m3)', 'Avg Phaeo (mg/m3)')

HAB_data_long_units = HAB_data_long %>% 
  mutate(Units = ifelse(grepl("pDA (ng/mL)", Observations),'ng/mL',
                        ifelse(grepl('Temp (deg C)', Observations), "Celsius",
                               ifelse(grepl("'Avg Chloro (mg/m3)'|'Avg Phaeo (mg/m3)'", Observations), "mg/m3",
                                      ifelse(grepl("'Pseudo-nitzschia delicatissima group (cells/L)'|
                                                     'Pseudo-nitzschia seriata group (cells/L)'|
                                                     'Alexandrium spp. (cells/L)'", Observations), "cells/L", "uM")))))

write_rds(HAB_data_long_units, "HABMAP_Data/HAB_data_long_units.rds")

#HAB_data_long = readRDS("HABMAP_Data/HAB_data_long.rds")

```
